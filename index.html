<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conservative Weather Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
    .weather-box { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
    h2 { margin-top: 0; }
  </style>
</head>
<body>
  <div class="weather-box">
    <h2>Conservative Weather Report</h2>
    <p><strong>Visibility:</strong> <span id="visibility">Loading...</span></p>
    <p><strong>Wind Speed:</strong> <span id="windSpeed">Loading...</span></p>
    <p><strong>Wind Gust:</strong> <span id="windGust">Loading...</span></p>
    <p><strong>Cloud Cover:</strong> <span id="cloudCover">Loading...</span></p>
  </div>

  <script>
    const lat = 51.605;
    const lon = -4.064;

    const openWeatherKey = '81a0d8bef1288c6437560f89b336dd33';
    const weatherbitKey = '0b4166c963064508b1267d1cac0741e1';
    const stormglassKey = '38300d82-5994-11f0-bc20-0242ac130006-38300e86-5994-11f0-bc20-0242ac130006';

    async function getOpenWeather() {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${openWeatherKey}&units=metric`;
      const res = await fetch(url);
      const data = await res.json();
      return {
        visibility: data.visibility / 1000, // meters to km
        windSpeed: data.wind.speed,
        windGust: data.wind.gust || data.wind.speed,
        cloudCover: data.clouds.all
      };
    }

    async function getWeatherbit() {
      const url = `https://api.weatherbit.io/v2.0/current?lat=${lat}&lon=${lon}&key=${weatherbitKey}`;
      const res = await fetch(url);
      const data = await res.json();
      const d = data.data[0];
      return {
        visibility: d.vis, // km
        windSpeed: d.wind_spd,
        windGust: d.wind_gust_spd || d.wind_spd,
        cloudCover: d.clouds
      };
    }

    async function getStormglass() {
      const params = ['visibility', 'windSpeed', 'windGust', 'cloudCover'].join(',');
      const url = `https://api.stormglass.io/v2/weather/point?lat=${lat}&lng=${lon}&params=${params}&source=sg`;
      const res = await fetch(url, {
        headers: { 'Authorization': stormglassKey }
      });
      const data = await res.json();
      const d = data.hours[0]; // current hour

      return {
        visibility: d.visibility?.sg ?? 10,
        windSpeed: d.windSpeed?.sg ?? 0,
        windGust: d.windGust?.sg ?? d.windSpeed?.sg ?? 0,
        cloudCover: d.cloudCover?.sg ?? 0
      };
    }

    function getConservative(values, key, isLowBetter = true) {
      const valid = values.map(v => v[key]).filter(v => typeof v === 'number');
      if (valid.length === 0) return 'N/A';
      return isLowBetter ? Math.min(...valid) : Math.max(...valid);
    }

    async function updateWeather() {
      try {
        const [owm, wb, sg] = await Promise.all([
          getOpenWeather(),
          getWeatherbit(),
          getStormglass()
        ]);

        const allData = [owm, wb, sg];

        const visibility = getConservative(allData, 'visibility', true);
        const windSpeed = getConservative(allData, 'windSpeed', false);
        const windGust = getConservative(allData, 'windGust', false);
        const cloudCover = getConservative(allData, 'cloudCover', false);

        document.getElementById('visibility').textContent = `${visibility} km`;
        document.getElementById('windSpeed').textContent = `${windSpeed} m/s`;
        document.getElementById('windGust').textContent = `${windGust} m/s`;
        document.getElementById('cloudCover').textContent = `${cloudCover}%`;
      } catch (error) {
        console.error('Weather fetch error:', error);
      }
    }

    updateWeather();
  </script>
</body>
</html>
